<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <canvas id="snake"></canvas>
    <script>
        /** é»˜è®¤é…ç½® */
        var config = {
            SIZE: 30,
            ROW: 20,
            COL: 20,
            GAP: 5,
            SNAKE: [[0, 0], [1, 0], [2, 0]],
            DIR: 'ArrowDown' // åˆå§‹ç§»åŠ¨æ–¹å‘
        };
        /** è´ªåƒè›‡ */
        var Game = /** @class */ (function () {
            function Game(config) {
                Object.assign(this, config);
            }
            /**
             * å¯åŠ¨æ¸¸æˆ
             */
            Game.prototype.start = function () {
                this.init();
                this.registEvent();
                this.scheduler = function (fn) { return setTimeout(fn, 600); };
                this.timer = this.scheduler(this.startRender.bind(this));
            };
            /**
             * å¯åŠ¨åŠ¨ç”»æ¸²æŸ“
             */
            Game.prototype.startRender = function () {
                if (this.isOver) {
                    return;
                }
                this.render(this.DIR);
                this.timer = this.scheduler(this.startRender.bind(this));
            };
            /**
             * åŠ¨ç”»æ¸²æŸ“ï¼ˆæ¸…é™¤ç”»å¸ƒï¼Œè¾¹ç•Œåˆ¤æ–­ï¼ŒğŸå‰è¿›ï¼Œæ¸²æŸ“é£Ÿç‰©ï¼Œåƒé£Ÿç‰©ï¼Œæ¸²æŸ“é£Ÿç‰©ï¼Œæ¸²æŸ“ğŸï¼‰
             * @param {*} dir ç§»åŠ¨æ–¹å‘
             */
            Game.prototype.render = function (dir) {
                // æŒ‰é”®ä¸å½“å‰ç§»åŠ¨æ–¹å‘ç›¸ååˆ™è¿”å›
                if (this.DIR === 'ArrowUp' && dir === 'ArrowDown') {
                    return;
                }
                if (this.DIR === 'ArrowDown' && dir === 'ArrowUp') {
                    return;
                }
                if (this.DIR === 'ArrowLeft' && dir === 'ArrowRight') {
                    return;
                }
                if (this.DIR === 'ArrowRight' && dir === 'ArrowLeft') {
                    return;
                }
                // ğŸå¤´
                var head = this.SNAKE[0];
                if (!this.checkBoundary(dir, head)) {
                    this.over();
                    return;
                }
                // æ–°å»ºä¸€ä¸ªğŸå¤´
                var newHead = [head[0], head[1]];
                var last = this.SNAKE[this.SNAKE.length - 1];
                var preLast = [last[0], last[1]];
                if (this.DIR !== dir) {
                    this.DIR = dir;
                }
                // æ–°ğŸå¤´æ ¹æ®æ–¹å‘ç§»åŠ¨
                switch (dir) {
                    case 'ArrowUp':
                        --newHead[1];
                        break;
                    case 'ArrowDown':
                        ++newHead[1];
                        break;
                    case 'ArrowLeft':
                        --newHead[0];
                        break;
                    case 'ArrowRight':
                        ++newHead[0];
                        break;
                    default: return;
                }
                // æ¸…ç©ºç”»å¸ƒ
                this.clearCanvas();
                // æ¸²æŸ“é£Ÿç‰©
                this.renderFoot();
                // ğŸèº«å‰è¿›
                for (var i = this.SNAKE.length - 1; i > 0; i--) {
                    this.SNAKE[i] = this.SNAKE[i - 1];
                }
                // é‡è®¾ğŸå¤´
                this.SNAKE[0] = newHead;
                // åƒåˆ°ä¸€ä¸ªé£Ÿç‰©ï¼ŒğŸèº«åé€€ï¼Œé£Ÿç‰©å˜ğŸå¤´
                this.eatFood(preLast);
                // æ¸²æŸ“ğŸ
                this.renderSnake();
            };
            /**
             * æ¸…é™¤ç”»å¸ƒ
             */
            Game.prototype.clearCanvas = function () {
                this.ctx.clearRect(0, 0, this.WIDTH, this.HEIHGT);
            };
            /**
             * åƒé£Ÿç‰©ï¼Œå°†é£Ÿç‰©æ¨å…¥ğŸï¼Œå˜ä¸ºğŸå¤´
             * @param {*} preLast ç§»åŠ¨ä¹‹å‰çš„ğŸçš„å°¾å·´
             */
            Game.prototype.eatFood = function (preLast) {
                // æ²¡æœ‰é£Ÿç‰©è¿”å›
                if (!this.food) {
                    return;
                }
                var _a = this.food, fx = _a[0], fy = _a[1];
                var _b = this.SNAKE[0], sx = _b[0], sy = _b[1];
                if (sx !== fx || sy !== fy) {
                    return;
                }
                var len = this.SNAKE.length;
                for (var i = 0; i < len - 1; i++) {
                    this.SNAKE[i] = this.SNAKE[i + 1];
                }
                this.SNAKE[len - 1] = preLast;
                this.SNAKE.unshift([fx, fy]);
                // æ¸…é™¤é£Ÿç‰©
                var _c = this.getRenderPoint(this.food), cx = _c[0], cy = _c[1];
                this.food = null;
                this.ctx.clearRect(cx, cy, this.SIZE, this.SIZE);
                // æ–°ç”Ÿæˆå¹¶æ¸²æŸ“ä¸€ä¸ªé£Ÿç‰©
                this.renderFoot();
                this.score = (this.score || 0) + 10;
                console.clear();
                console.log('åˆ†æ•°ï¼š', this.score);
            };
            /**
             * è·å–çœŸæ­£çš„æ¸²æŸ“åæ ‡ï¼ˆåŒ…å«æ–¹å—ä¹‹é—´çš„é—´éš™ï¼‰
             * @param {*} item åæ ‡
             */
            Game.prototype.getRenderPoint = function (item) {
                var x = item[0], y = item[1];
                return [x * this.SIZE + (x + 1) * this.GAP, y * this.SIZE + (y + 1) * this.GAP];
            };
            /**
             * æ³¨å†Œäº‹ä»¶
             */
            Game.prototype.registEvent = function () {
                var _this = this;
                this.event = function (e) { return _this.render(e.key); };
                window.addEventListener('keydown', this.event);
            };
            /**
             * ç»“æŸæ¸¸æˆ
             */
            Game.prototype.over = function () {
                window.removeEventListener('keydown', this.event);
                this.isOver = true;
                clearTimeout(this.timer);
                alert('æ¸¸æˆç»“æŸï¼Œåˆ†æ•°ï¼š' + (this.score || 0));
            };
            /**
             * æ¸²æŸ“é£Ÿç‰©
             */
            Game.prototype.renderFoot = function () {
                if (!this.food) {
                    this.createFood();
                }
                var _a = this.getRenderPoint(this.food), x = _a[0], y = _a[1];
                this.ctx.fillStyle = 'white';
                this.ctx.fillRect(x, y, this.SIZE, this.SIZE);
            };
            /**
             * ç”Ÿæˆé£Ÿç‰©ï¼ˆä¸èƒ½å’ŒğŸèº«é‡åˆï¼‰
             */
            Game.prototype.createFood = function () {
                var x = ~~(Math.random() * this.COL);
                var y = ~~(Math.random() * this.ROW);
                var cross = this.SNAKE.some(function (item) {
                    return x === item[0] && y === item[1];
                });
                if (cross) {
                    this.createFood();
                }
                return this.food = [x, y];
            };
            /**
             * æ£€æŸ¥ğŸæ˜¯å¦è¶Šç•Œï¼ˆè¿™é‡Œæ²¡æœ‰åˆ¤æ–­ğŸå¤´å’ŒğŸèº«é‡åˆï¼‰
             * @param {*} dir ğŸçš„ç§»åŠ¨æ–¹å‘
             * @param {*} head ğŸå¤´
             */
            Game.prototype.checkBoundary = function (dir, head) {
                var x = head[0], y = head[1];
                switch (dir) {
                    case 'ArrowUp': return y > 0;
                    case 'ArrowLeft': return x > 0;
                    case 'ArrowDown': return y < this.ROW - 1;
                    case 'ArrowRight': return x < this.COL - 1;
                    default: break;
                }
                return true;
            };
            /**
             * æ¸²æŸ“ğŸ
             */
            Game.prototype.renderSnake = function () {
                for (var i = 0, len = this.SNAKE.length; i < len; i++) {
                    var cur = this.SNAKE[i];
                    var x1 = cur[0], y1 = cur[1];
                    var _a = this.getRenderPoint(cur), sx = _a[0], sy = _a[1];
                    this.ctx.fillStyle = i === 0 ? 'orange' : 'white';
                    this.ctx.fillRect(sx, sy, this.SIZE, this.SIZE);
                    // å¡«å……æˆ–æ¸…é™¤é—´éš™
                    if (i >= len - 1) {
                        continue;
                    }
                    var nex = this.SNAKE[i + 1];
                    var x2 = nex[0], y2 = nex[1];
                    var gx = void 0, gy = void 0, w = void 0, h = void 0;
                    if (y1 === y2) {
                        gx = x2 > x1 ? sx + this.SIZE : sx - this.GAP;
                        gy = sy;
                        w = this.GAP;
                        h = this.SIZE;
                    }
                    else if (x1 === x2) {
                        gx = sx;
                        gy = y2 > y1 ? sy + this.SIZE : sy - this.GAP;
                        w = this.SIZE;
                        h = this.GAP;
                    }
                    this.ctx.fillRect(gx, gy, w, h);
                }
            };
            /**
             * åˆå§‹åŒ–å‚æ•°
             */
            Game.prototype.init = function () {
                var canvas = document.getElementById('snake');
                this.ctx = canvas.getContext('2d');
                // è®¾ç½®ç”»å¸ƒå®½é«˜
                var w = this.SIZE * this.COL + this.GAP * (this.COL + 1);
                var h = this.SIZE * this.ROW + this.GAP * (this.ROW + 1);
                canvas.style.backgroundColor = '#000';
                this.WIDTH = canvas.width = w;
                this.HEIHGT = canvas.height = h;
                this.food = null;
            };
            return Game;
        }());
        new Game(config).start();
    </script>
</body>

</html>